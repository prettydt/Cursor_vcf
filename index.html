<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- SEOä¼˜åŒ– -->
    <title>Excelè½¬VCFå·¥å…· - å…è´¹åœ¨çº¿æ‰¹é‡å¯¼å…¥iPhoneé€šè®¯å½•</title>
    <meta name="description" content="å…è´¹çš„Excelè½¬VCFå·¥å…·ï¼Œæ”¯æŒæ‰¹é‡å°†Excelè”ç³»äººè½¬æ¢ä¸ºVCFæ ¼å¼ï¼Œä¸€é”®å¯¼å…¥iPhoneé€šè®¯å½•ã€‚æ”¯æŒä¸­è‹±æ–‡åˆ—åï¼Œå®Œç¾å…¼å®¹iOSç³»ç»Ÿï¼Œæ— éœ€å®‰è£…ä»»ä½•è½¯ä»¶ã€‚">
    <meta name="keywords" content="Excelè½¬VCF,é€šè®¯å½•å¯¼å…¥,iPhoneè”ç³»äºº,æ‰¹é‡å¯¼å…¥,VCFå·¥å…·,vCardè½¬æ¢,åœ¨çº¿å·¥å…·,è”ç³»äººç®¡ç†">
    <meta name="author" content="Cursor VCF Tool">
    
    <!-- ç¤¾äº¤åª’ä½“åˆ†äº«ä¼˜åŒ– (Open Graph) -->
    <meta property="og:title" content="Excelè½¬VCFå·¥å…· - å…è´¹æ‰¹é‡å¯¼å…¥iPhoneé€šè®¯å½•">
    <meta property="og:description" content="ä¸€é”®å°†Excelè”ç³»äººè½¬æ¢ä¸ºVCFæ ¼å¼ï¼Œæ‰¹é‡å¯¼å…¥iPhoneé€šè®¯å½•ã€‚å®Œå…¨åœ¨çº¿ï¼Œæ— éœ€å®‰è£…ã€‚">
    <meta property="og:type" content="website">
    <!-- <meta property="og:image" content="https://prettydt.github.io/Cursor_vcf/preview.png"> -->
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Excelè½¬VCFå·¥å…· - å…è´¹æ‰¹é‡å¯¼å…¥iPhoneé€šè®¯å½•">
    <meta name="twitter:description" content="ä¸€é”®å°†Excelè”ç³»äººè½¬æ¢ä¸ºVCFæ ¼å¼ï¼Œæ‰¹é‡å¯¼å…¥iPhoneé€šè®¯å½•">
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <!-- å›¾æ ‡æ–‡ä»¶éœ€è¦ç”Ÿæˆåå†å¯ç”¨ï¼Œå‚è€ƒã€Šç”Ÿæˆå›¾æ ‡æŒ‡å—.mdã€‹ -->
    <!-- <link rel="apple-touch-icon" href="icon-192.png"> -->
    
    <!-- Favicon - å›¾æ ‡æ–‡ä»¶éœ€è¦ç”Ÿæˆåå†å¯ç”¨ -->
    <!-- <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"> -->
    <!-- XLSX åº“ - å¼‚æ­¥åŠ è½½ï¼Œæ”¯æŒå¤šä¸ªå¤‡ç”¨æº -->
    <script>
        (function() {
            const CDN_SOURCES = [
                'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
            ];
            
            let currentIndex = 0;
            
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    if (typeof XLSX !== 'undefined') {
                        resolve();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    
                    script.onload = function() {
                        console.log('âœ… XLSXåº“åŠ è½½æˆåŠŸ:', src);
                        resolve();
                    };
                    
                    script.onerror = function() {
                        console.warn('âŒ CDNåŠ è½½å¤±è´¥:', src);
                        reject();
                    };
                    
                    document.head.appendChild(script);
                    
                    // è®¾ç½®è¶…æ—¶ï¼ˆ30ç§’ï¼‰
                    setTimeout(() => {
                        if (typeof XLSX === 'undefined') {
                            reject(new Error('åŠ è½½è¶…æ—¶'));
                        }
                    }, 30000);
                });
            }
            
            function tryLoadNext() {
                if (currentIndex >= CDN_SOURCES.length) {
                    console.error('æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥');
                    document.dispatchEvent(new CustomEvent('xlsx-load-failed'));
                    return;
                }
                
                loadScript(CDN_SOURCES[currentIndex])
                    .then(() => {
                        document.dispatchEvent(new CustomEvent('xlsx-loaded'));
                    })
                    .catch(() => {
                        currentIndex++;
                        setTimeout(tryLoadNext, 500); // ç­‰å¾…500msåå°è¯•ä¸‹ä¸€ä¸ª
                    });
            }
            
            // å¼€å§‹åŠ è½½
            tryLoadNext();
        })();
    </script>
    
    <!-- ç»“æ„åŒ–æ•°æ® (SEOä¼˜åŒ–) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Excelè½¬VCFå·¥å…·",
      "alternateName": "Excel to VCF Converter",
      "description": "å…è´¹çš„Excelè½¬VCFå·¥å…·ï¼Œæ”¯æŒæ‰¹é‡å°†Excelè”ç³»äººè½¬æ¢ä¸ºVCFæ ¼å¼ï¼Œä¸€é”®å¯¼å…¥iPhoneé€šè®¯å½•ã€‚æ”¯æŒä¸­è‹±æ–‡åˆ—åï¼Œå®Œç¾å…¼å®¹iOSç³»ç»Ÿã€‚",
      "url": "https://prettydt.github.io/Cursor_vcf/",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web Browser, iOS, Android, Windows, macOS",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CNY"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5",
        "ratingCount": "1"
      },
      "author": {
        "@type": "Organization",
        "name": "Cursor VCF Tool"
      },

      "softwareVersion": "1.0",
      "datePublished": "2024-12-04",
      "inLanguage": "zh-CN",
      "keywords": "Excelè½¬VCF,é€šè®¯å½•å¯¼å…¥,iPhoneè”ç³»äºº,æ‰¹é‡å¯¼å…¥,VCFå·¥å…·,vCardè½¬æ¢",
      "featureList": [
        "æ‰¹é‡è½¬æ¢Excelè”ç³»äºº",
        "æ”¯æŒä¸­è‹±æ–‡åˆ—å",
        "å…¼å®¹iOSç³»ç»Ÿ",
        "åœ¨çº¿è½¬æ¢ï¼Œæ— éœ€å®‰è£…",
        "å®Œå…¨å…è´¹"
      ]
    }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .log-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: #333;
            margin-bottom: 15px;
            display: none;
        }

        .log-area.active {
            display: block;
        }
        
        /* ä¸Šä¼ åŒºåŸŸå¢å¼ºè§†è§‰åé¦ˆ */
        .upload-area.has-file {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        
        .upload-area.has-file .upload-text {
            color: #2e7d32;
        }

        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #007bff;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            display: none;
        }

        .result-area.active {
            display: block;
        }

        .result-text {
            color: #2e7d32;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
        }

        .info-text {
            color: #424242;
            font-size: 13px;
            line-height: 1.6;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            color: white;
            font-size: 12px;
        }

        /* åˆ—æ˜ å°„åŒºåŸŸæ ·å¼ */
        .mapping-area {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .mapping-area.active {
            display: block;
        }

        .mapping-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .mapping-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            gap: 12px;
            width: 100%;
            box-sizing: border-box;
        }

        .mapping-label {
            min-width: 80px;
            max-width: 120px;
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .mapping-select {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            height: 42px;
            box-sizing: border-box;
            line-height: 20px;
            margin: 0;
            vertical-align: middle;
            width: 100%;
            max-width: 100%;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .mapping-required {
            color: #dc3545;
            font-size: 12px;
            margin-left: 5px;
        }

        .sample-data {
            margin-top: 15px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 12px;
            color: #856404;
        }

        .sample-data-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* ====== å“åº”å¼è®¾è®¡å¢å¼º ====== */
        
        /* è¶…å°å±å¹•æ‰‹æœº (iPhone SE, etc) */
        @media (max-width: 375px) {
            body {
                padding: 15px 10px;
            }
            
            .container {
                padding: 20px 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .mapping-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .mapping-label {
                width: 100%;
                margin-bottom: 5px;
            }
        }
        
        /* å°å±å¹•æ‰‹æœº */
        @media (max-width: 480px) {
            .info-box {
                padding: 12px;
                font-size: 12px;
            }
            
            .log-area {
                font-size: 11px;
                max-height: 150px;
            }
        }
        
        /* å¹³æ¿æ¨ªå±å’Œå°æ¡Œé¢ */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 700px;
                padding: 40px;
            }
            
            h1 {
                font-size: 32px;
            }
            
            .upload-area {
                padding: 50px 30px;
            }
        }
        
        /* å¤§å±å¹•æ¡Œé¢ */
        @media (min-width: 1024px) {
            .container {
                max-width: 800px;
                padding: 40px 50px;
            }
            
            h1 {
                font-size: 32px;
            }
            
            .subtitle {
                font-size: 16px;
            }
            
            .upload-area {
                padding: 60px 40px;
            }
            
            .upload-icon {
                font-size: 60px;
            }
            
            .btn {
                padding: 16px;
                font-size: 17px;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ–ï¼ˆå¢å¤§æŒ‰é’®å’Œäº¤äº’åŒºåŸŸï¼‰ */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                padding: 18px;
                font-size: 18px;
                min-height: 50px;
            }
            
            .upload-area {
                padding: 50px 20px;
                min-height: 200px;
            }
            
            .mapping-select {
                padding: 12px;
                font-size: 16px;
                min-height: 48px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .info-box {
                margin-bottom: 15px;
            }
        }
        
        /* æ‰“å°æ ·å¼ä¼˜åŒ– */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .btn, .upload-area, .footer {
                display: none;
            }
        }
        
        /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
        @media (prefers-contrast: high) {
            .container {
                border: 2px solid #000;
            }
            
            .btn-primary {
                background: #000;
                color: #fff;
            }
            
            .upload-area {
                border-color: #000;
                border-width: 3px;
            }
        }
        
        /* å‡å°‘åŠ¨ç”»ï¼ˆé’ˆå¯¹ç”¨æˆ·åå¥½ï¼‰ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
        
        /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
            
            .container {
                background: #2a2a3e;
                color: #e0e0e0;
            }
            
            h1, .info-title, .mapping-title {
                color: #e0e0e0;
            }
            
            .subtitle, .info-text {
                color: #b0b0b0;
            }
            
            .upload-area {
                background: #3a3a4e;
                border-color: #667eea;
            }
            
            .upload-area:hover {
                background: #4a4a5e;
            }
            
            .info-box {
                background: #1e3a5f;
                border-left-color: #4a90e2;
            }
            
            .log-area {
                background: #3a3a4e;
                color: #e0e0e0;
            }
            
            .mapping-area {
                background: #3a3a4e;
            }
            
            .mapping-select {
                background: #2a2a3e;
                color: #e0e0e0;
                border-color: #555;
            }
            
            .btn-secondary {
                background: #3a3a4e;
                color: #e0e0e0;
            }
            
            .btn-secondary:hover {
                background: #4a4a5e;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± Excelè½¬VCFå·¥å…·</h1>
        <div class="subtitle">å¿«é€Ÿå°†Excelè”ç³»äººå¯¼å…¥iPhoneé€šè®¯å½•</div>

        <div class="info-box">
            <div class="info-title">ğŸ“‹ ä½¿ç”¨è¯´æ˜</div>
            <div class="info-text">
                1. ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆæ”¯æŒ .xlsx å’Œ .xlsï¼‰<br>
                2. é€‰æ‹©åˆ—æ˜ å°„å…³ç³»ï¼ˆå°†Excelåˆ—æ˜ å°„åˆ°VCFå­—æ®µï¼‰<br>
                3. ç¡®è®¤æ˜ å°„å¹¶è½¬æ¢<br>
                4. ä¸‹è½½VCFæ–‡ä»¶å¯¼å…¥iPhoneé€šè®¯å½•
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½Excelæ–‡ä»¶</div>
            <div class="upload-hint">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</div>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />

        <!-- åˆ—æ˜ å°„åŒºåŸŸ -->
        <div class="mapping-area" id="mappingArea">
            <div class="mapping-title">ğŸ“‹ è¯·é€‰æ‹©åˆ—æ˜ å°„å…³ç³»</div>
            <div id="mappingContent"></div>
            <div class="sample-data" id="sampleData" style="display: none;">
                <div class="sample-data-title">é¢„è§ˆæ•°æ®ï¼ˆç¬¬ä¸€è¡Œï¼‰ï¼š</div>
                <div id="sampleDataContent"></div>
            </div>
            <button class="btn btn-primary" id="confirmMappingBtn" style="margin-top: 15px;">âœ… ç¡®è®¤æ˜ å°„å¹¶è½¬æ¢</button>
        </div>

        <button class="btn btn-primary" id="convertBtn" disabled style="display: none;">ğŸš€ å¼€å§‹è½¬æ¢</button>
        
        <div class="log-area" id="logArea"></div>

        <div class="result-area" id="resultArea">
            <div class="result-text">âœ… è½¬æ¢å®Œæˆï¼</div>
            <button class="btn btn-secondary" id="downloadBtn">ğŸ“¥ ä¸‹è½½VCFæ–‡ä»¶</button>
        </div>
    </div>

    <div class="footer">
        Excelè½¬VCFå·¥å…· v1.0 | æ”¯æŒiPhone/iPad
    </div>

    <script>
        let workbook = null;
        let vcfContent = '';
        let fileName = '';
        let excelColumns = [];
        let excelData = [];
        let columnMapping = {}; // ç”¨æˆ·é€‰æ‹©çš„æ˜ å°„å…³ç³»

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const logArea = document.getElementById('logArea');
        const resultArea = document.getElementById('resultArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const mappingArea = document.getElementById('mappingArea');
        const mappingContent = document.getElementById('mappingContent');
        const sampleData = document.getElementById('sampleData');
        const sampleDataContent = document.getElementById('sampleDataContent');
        const confirmMappingBtn = document.getElementById('confirmMappingBtn');

        // XLSXåº“åŠ è½½çŠ¶æ€
        let xlsxLoaded = false;
        let xlsxLoadFailed = false;

        // æ£€æŸ¥ XLSX åº“æ˜¯å¦åŠ è½½
        function checkXLSXLibrary() {
            if (typeof XLSX !== 'undefined') {
                xlsxLoaded = true;
                console.log('âœ… XLSX åº“å·²åŠ è½½');
                return true;
            }
            return false;
        }

        // ç›‘å¬XLSXåº“åŠ è½½äº‹ä»¶
        document.addEventListener('xlsx-loaded', () => {
            xlsxLoaded = true;
            console.log('âœ… XLSXåº“åŠ è½½å®Œæˆäº‹ä»¶è§¦å‘');
            uploadArea.style.opacity = '1';
            uploadArea.style.pointerEvents = 'auto';
            uploadArea.querySelector('.upload-hint').textContent = 'æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼';
        });

        document.addEventListener('xlsx-load-failed', () => {
            xlsxLoadFailed = true;
            console.error('âŒ XLSXåº“åŠ è½½å¤±è´¥');
            uploadArea.style.opacity = '0.5';
            uploadArea.style.pointerEvents = 'none';
            uploadArea.querySelector('.upload-hint').innerHTML = 
                '<span style="color: red;">âš ï¸ åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œ</span>';
            alert('âš ï¸ Excelå¤„ç†åº“åŠ è½½å¤±è´¥ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. CDNæœåŠ¡ä¸å¯ç”¨\n\nå»ºè®®ï¼š\n1. åˆ·æ–°é¡µé¢é‡è¯•\n2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n3. å¦‚æœæŒç»­å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä»£ç†æˆ–VPN');
        });

        // é¡µé¢åŠ è½½åï¼Œå®šæœŸæ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
        let checkCount = 0;
        const maxChecks = 20; // 10ç§’
        
        window.addEventListener('load', () => {
            const checkInterval = setInterval(() => {
                checkCount++;
                if (checkXLSXLibrary()) {
                    clearInterval(checkInterval);
                    document.dispatchEvent(new CustomEvent('xlsx-loaded'));
                } else if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    if (!xlsxLoaded) {
                        document.dispatchEvent(new CustomEvent('xlsx-load-failed'));
                    }
                }
            }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡
        });

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        uploadArea.addEventListener('click', () => {
            if (!checkXLSXLibrary()) return;
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);
            if (file) {
                handleFile(file);
            } else {
                console.log('æœªé€‰æ‹©æ–‡ä»¶');
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            console.log('æ‹–æ‹½æ–‡ä»¶:', files.length, 'ä¸ªæ–‡ä»¶');
            
            if (files.length === 0) {
                alert('âŒ æœªæ£€æµ‹åˆ°æ–‡ä»¶');
                return;
            }
            
            const file = files[0];
            console.log('æ‹–æ‹½çš„æ–‡ä»¶:', file.name, file.type);
            
            if (file) {
                handleFile(file);
            } else {
                alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        function handleFile(file) {
            // é¦–å…ˆæ£€æŸ¥ XLSX åº“æ˜¯å¦å¯ç”¨
            if (typeof XLSX === 'undefined' || !xlsxLoaded) {
                alert('âŒ Excelå¤„ç†åº“æœªåŠ è½½ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. åº“ä»åœ¨åŠ è½½ä¸­\n\nå»ºè®®ï¼š\n1. ç­‰å¾…å‡ ç§’åé‡è¯•\n2. åˆ·æ–°é¡µé¢\n3. æ£€æŸ¥ç½‘ç»œè¿æ¥');
                console.error('XLSX is not defined or not loaded yet');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file) {
                alert('âŒ æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const validExtensions = ['.xlsx', '.xls'];
            const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!validExtensions.includes(fileExt)) {
                alert('âŒ æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼è¯·é€‰æ‹© .xlsx æˆ– .xls æ ¼å¼çš„Excelæ–‡ä»¶');
                return;
            }
            
            // æ›´æ–°ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
            uploadArea.classList.add('has-file');
            uploadArea.querySelector('.upload-text').textContent = 'âœ… ' + file.name;
            uploadArea.querySelector('.upload-hint').textContent = 'æ–‡ä»¶å·²é€‰æ‹©ï¼Œæ­£åœ¨å¤„ç†...';
            
            fileName = file.name.replace(/\.(xlsx|xls)$/i, '');
            
            // æ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
            logArea.classList.add('active');
            logArea.innerHTML = '';
            
            log('ğŸ“ æ­£åœ¨è¯»å–æ–‡ä»¶: ' + file.name, 'info');
            console.log('å¤„ç†æ–‡ä»¶:', file.name, file.size, 'bytes');
            
            const reader = new FileReader();
            
            // æ·»åŠ é”™è¯¯å¤„ç†
            reader.onerror = (e) => {
                console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', e);
                log('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå');
            };
            
            reader.onload = (e) => {
                try {
                    console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æ...');
                    const data = new Uint8Array(e.target.result);
                    log('ğŸ“Š æ­£åœ¨è§£æExcelæ•°æ®...', 'info');
                    
                    workbook = XLSX.read(data, { type: 'array' });
                    console.log('Excelè§£ææˆåŠŸï¼Œå·¥ä½œè¡¨:', workbook.SheetNames);
                    log('âœ… æ–‡ä»¶è¯»å–æˆåŠŸ', 'success');
                    
                    // è¯»å–æ•°æ®
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet);
                    
                    console.log('æ•°æ®è¡Œæ•°:', excelData.length);
                    console.log('ç¬¬ä¸€è¡Œæ•°æ®:', excelData[0]);
                    
                    if (excelData.length === 0) {
                        throw new Error('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    // è·å–æ‰€æœ‰åˆ—å
                    excelColumns = Object.keys(excelData[0]);
                    console.log('Excelåˆ—å:', excelColumns);
                    log(`âœ… æ‰¾åˆ° ${excelData.length} è¡Œæ•°æ®ï¼Œ${excelColumns.length} åˆ—`, 'success');
                    
                    // æ˜¾ç¤ºæ˜ å°„ç•Œé¢
                    showMappingInterface();
                } catch (error) {
                    console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    log('âŒ å¤„ç†å¤±è´¥: ' + error.message, 'error');
                    alert('æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š' + error.message + '\n\nè¯·æ£€æŸ¥ï¼š\n1. æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„Excelæ ¼å¼\n2. æ–‡ä»¶æ˜¯å¦åŒ…å«æ•°æ®\n3. æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // æ˜¾ç¤ºåˆ—æ˜ å°„ç•Œé¢
        function showMappingInterface() {
            // å®šä¹‰VCFå­—æ®µ
            const vcfFields = [
                { key: 'name', label: 'å§“å', required: true, icon: 'ğŸ‘¤' },
                { key: 'phone', label: 'ç”µè¯', required: false, icon: 'ğŸ“' },
                { key: 'mobile', label: 'æ‰‹æœº', required: false, icon: 'ğŸ“±' },
                { key: 'email', label: 'é‚®ç®±', required: false, icon: 'ğŸ“§' },
                { key: 'company', label: 'å…¬å¸', required: false, icon: 'ğŸ¢' },
                { key: 'title', label: 'èŒä½', required: false, icon: 'ğŸ’¼' },
                { key: 'address', label: 'åœ°å€', required: false, icon: 'ğŸ“' },
                { key: 'note', label: 'å¤‡æ³¨', required: false, icon: 'ğŸ“' }
            ];

            let html = '';
            
            // ä¸ºæ¯ä¸ªVCFå­—æ®µåˆ›å»ºé€‰æ‹©å™¨
            vcfFields.forEach(field => {
                html += `
                    <div class="mapping-row">
                        <div class="mapping-label">
                            ${field.icon} ${field.label}
                            ${field.required ? '<span class="mapping-required">*</span>' : ''}
                        </div>
                        <select class="mapping-select" data-field="${field.key}" id="mapping_${field.key}">
                            <option value="">-- è¯·é€‰æ‹©Excelåˆ— --</option>
                            ${excelColumns.map(col => 
                                `<option value="${col}">${col}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            });
            
            mappingContent.innerHTML = html;
            mappingArea.classList.add('active');
            
            // å°è¯•è‡ªåŠ¨è¯†åˆ«å¹¶é¢„é€‰
            autoDetectMapping(vcfFields);
            
            // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
            showDataPreview();
        }

        // è‡ªåŠ¨è¯†åˆ«åˆ—æ˜ å°„
        function autoDetectMapping(vcfFields) {
            const namePatterns = {
                'name': ['å§“å', 'name', 'Name', 'åå­—', 'è”ç³»äºº', 'Full Name', 'fullname', 'full_name'],
                'phone': ['ç”µè¯', 'phone', 'Phone', 'ç”µè¯å·', 'Tel', 'TEL', 'tel', 'telephone'],
                'mobile': ['æ‰‹æœº', 'mobile', 'Mobile', 'æ‰‹æœºå·', 'æ‰‹æœºå·ç ', 'cell', 'Cell'],
                'email': ['é‚®ç®±', 'email', 'Email', 'é‚®ä»¶', 'ç”µå­é‚®ç®±', 'mail', 'Mail'],
                'company': ['å…¬å¸', 'company', 'Company', 'å•ä½', 'å·¥ä½œå•ä½', 'org', 'organization'],
                'title': ['èŒä½', 'title', 'Title', 'èŒåŠ¡', 'èŒç§°', 'position', 'Position'],
                'address': ['åœ°å€', 'address', 'Address', 'ä½å€', 'addr'],
                'note': ['å¤‡æ³¨', 'note', 'Note', 'è¯´æ˜', 'æ³¨é‡Š', 'comments', 'remark']
            };

            vcfFields.forEach(field => {
                const patterns = namePatterns[field.key] || [];
                const select = document.getElementById(`mapping_${field.key}`);
                
                if (select) {
                    // æŸ¥æ‰¾åŒ¹é…çš„åˆ—
                    for (let col of excelColumns) {
                        const colLower = col.toLowerCase().trim();
                        if (patterns.some(pattern => colLower.includes(pattern.toLowerCase()) || col === pattern)) {
                            select.value = col;
                            break;
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
        function showDataPreview() {
            if (excelData.length > 0) {
                const firstRow = excelData[0];
                let previewHtml = '';
                
                excelColumns.forEach(col => {
                    const value = firstRow[col];
                    previewHtml += `<strong>${col}:</strong> ${value || '(ç©º)'} &nbsp;&nbsp;`;
                });
                
                sampleDataContent.innerHTML = previewHtml;
                sampleData.style.display = 'block';
            }
        }

        // ç¡®è®¤æ˜ å°„å¹¶è½¬æ¢
        confirmMappingBtn.addEventListener('click', () => {
            // æ”¶é›†æ˜ å°„å…³ç³»
            columnMapping = {};
            const selects = mappingArea.querySelectorAll('.mapping-select');
            
            selects.forEach(select => {
                const field = select.dataset.field;
                const column = select.value;
                if (column) {
                    columnMapping[field] = column;
                }
            });
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const nameMapping = columnMapping['name'];
            if (!nameMapping) {
                alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©"å§“å"åˆ—çš„æ˜ å°„ï¼');
                return;
            }
            
            // éšè—æ˜ å°„ç•Œé¢ï¼Œå¼€å§‹è½¬æ¢
            mappingArea.classList.remove('active');
            performConvert();
        });

        // æ‰§è¡Œè½¬æ¢ï¼ˆä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ˜ å°„ï¼‰
        function performConvert() {
            if (!workbook || !excelData || excelData.length === 0) return;
            
            logArea.classList.add('active');
            logArea.innerHTML = '';
            
            log('å¼€å§‹è½¬æ¢...', 'info');
            log(`æ‰¾åˆ° ${excelData.length} è¡Œæ•°æ®`, 'info');
            
            try {
                // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ˜ å°„å…³ç³»
                const nameCol = columnMapping['name'];
                if (!nameCol) {
                    throw new Error('æœªé€‰æ‹©å§“ååˆ—çš„æ˜ å°„');
                }
                
                // ç”ŸæˆVCF
                vcfContent = '';
                let count = 0;
                
                excelData.forEach((row, index) => {
                    const name = String(row[nameCol] || '').trim();
                    if (!name || name === 'undefined' || name === 'null' || name === '' || name === 'NaN') {
                        return;
                    }
                    
                    // å¼€å§‹ä¸€ä¸ªVCard
                    vcfContent += 'BEGIN:VCARD\n';
                    vcfContent += 'VERSION:3.0\n';
                    
                    // å¤„ç†å§“åï¼ˆFNå­—æ®µï¼šå…¨åï¼‰
                    vcfContent += `FN:${name}\n`;
                    
                    // å¤„ç†å§“åï¼ˆNå­—æ®µï¼šå§“;å;;;ï¼‰
                    const nameParts = name.split(/\s+/);
                    if (nameParts.length >= 2) {
                        const lastName = nameParts[0];
                        const firstName = nameParts.slice(1).join(' ');
                        vcfContent += `N:${lastName};${firstName};;;\n`;
                    } else {
                        vcfContent += `N:;${name};;;\n`;
                    }
                    
                    // ç”µè¯ï¼ˆä¼˜å…ˆä½¿ç”¨phoneï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨mobileï¼‰
                    let phoneCol = columnMapping['phone'] || columnMapping['mobile'];
                    if (phoneCol && row[phoneCol]) {
                        const phone = String(row[phoneCol]).trim();
                        if (phone && phone !== 'undefined' && phone !== 'null' && phone !== 'NaN') {
                            vcfContent += `TEL;TYPE=WORK,VOICE:${phone}\n`;
                        }
                    }
                    
                    // æ‰‹æœºï¼ˆå¦‚æœå’Œphoneä¸åŒï¼‰
                    if (columnMapping['mobile'] && columnMapping['mobile'] !== phoneCol) {
                        const mobile = String(row[columnMapping['mobile']] || '').trim();
                        if (mobile && mobile !== 'undefined' && mobile !== 'null' && mobile !== 'NaN') {
                            vcfContent += `TEL;TYPE=CELL:${mobile}\n`;
                        }
                    }
                    
                    // é‚®ç®±
                    if (columnMapping['email'] && row[columnMapping['email']]) {
                        const email = String(row[columnMapping['email']]).trim();
                        if (email && email.includes('@') && email !== 'undefined' && email !== 'null') {
                            vcfContent += `EMAIL;TYPE=INTERNET:${email}\n`;
                        }
                    }
                    
                    // å…¬å¸
                    if (columnMapping['company'] && row[columnMapping['company']]) {
                        const company = String(row[columnMapping['company']]).trim();
                        if (company && company !== 'undefined' && company !== 'null' && company !== 'NaN') {
                            vcfContent += `ORG:${company}\n`;
                        }
                    }
                    
                    // èŒä½
                    if (columnMapping['title'] && row[columnMapping['title']]) {
                        const title = String(row[columnMapping['title']]).trim();
                        if (title && title !== 'undefined' && title !== 'null' && title !== 'NaN') {
                            vcfContent += `TITLE:${title}\n`;
                        }
                    }
                    
                    // åœ°å€
                    if (columnMapping['address'] && row[columnMapping['address']]) {
                        const address = String(row[columnMapping['address']]).trim();
                        if (address && address !== 'undefined' && address !== 'null' && address !== 'NaN') {
                            vcfContent += `ADR;TYPE=HOME:;;${address};;;;\n`;
                        }
                    }
                    
                    // å¤‡æ³¨
                    if (columnMapping['note'] && row[columnMapping['note']]) {
                        const note = String(row[columnMapping['note']]).trim();
                        if (note && note !== 'undefined' && note !== 'null' && note !== 'NaN') {
                            vcfContent += `NOTE:${note}\n`;
                        }
                    }
                    
                    // ç»“æŸVCard
                    vcfContent += 'END:VCARD\n\n';
                    count++;
                });
                
                log(`âœ… æˆåŠŸè½¬æ¢ ${count} ä¸ªè”ç³»äºº`, 'success');
                resultArea.classList.add('active');
                
            } catch (error) {
                log('âŒ è½¬æ¢å¤±è´¥: ' + error.message, 'error');
                alert('è½¬æ¢å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ—§çš„è½¬æ¢æŒ‰é’®ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰
        convertBtn.addEventListener('click', () => {
            if (!workbook) return;
            
            logArea.classList.add('active');
            logArea.innerHTML = '';
            convertBtn.disabled = true;
            
            log('å¼€å§‹è½¬æ¢...', 'info');
            
            try {
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(worksheet);
                
                if (data.length === 0) {
                    throw new Error('Excelæ–‡ä»¶ä¸ºç©º');
                }
                
                log(`æ‰¾åˆ° ${data.length} è¡Œæ•°æ®`, 'info');
                
                // æŸ¥æ‰¾åˆ—å
                const findColumn = (row, possibleNames) => {
                    for (let name of possibleNames) {
                        if (row.hasOwnProperty(name)) return name;
                    }
                    return null;
                };
                
                const nameCol = findColumn(data[0], ['å§“å', 'name', 'Name', 'åå­—', 'è”ç³»äºº', 'Full Name']) || 
                               Object.keys(data[0])[0];
                
                const phoneCol = findColumn(data[0], ['æ‰‹æœº', 'mobile', 'Mobile', 'ç”µè¯', 'phone', 'Phone', 'ç”µè¯å·', 'æ‰‹æœºå·']);
                const emailCol = findColumn(data[0], ['é‚®ç®±', 'email', 'Email', 'é‚®ä»¶', 'ç”µå­é‚®ç®±']);
                const companyCol = findColumn(data[0], ['å…¬å¸', 'company', 'Company', 'å•ä½', 'å·¥ä½œå•ä½']);
                const titleCol = findColumn(data[0], ['èŒä½', 'title', 'Title', 'èŒåŠ¡', 'èŒç§°']);
                
                log(`è¯†åˆ«åˆ—å: å§“å=${nameCol}, æ‰‹æœº=${phoneCol || 'æ— '}, é‚®ç®±=${emailCol || 'æ— '}`, 'info');
                
                // ç”ŸæˆVCF
                vcfContent = '';
                let count = 0;
                
                data.forEach((row, index) => {
                    const name = String(row[nameCol] || '').trim();
                    if (!name || name === 'undefined' || name === 'null' || name === '') {
                        return;
                    }
                    
                    vcfContent += 'BEGIN:VCARD\n';
                    vcfContent += 'VERSION:3.0\n';
                    vcfContent += `FN:${name}\n`;
                    vcfContent += `N:;${name};;;\n`;
                    
                    if (phoneCol && row[phoneCol]) {
                        const phone = String(row[phoneCol]).trim();
                        if (phone) {
                            vcfContent += `TEL;TYPE=CELL:${phone}\n`;
                        }
                    }
                    
                    if (emailCol && row[emailCol]) {
                        const email = String(row[emailCol]).trim();
                        if (email && email.includes('@')) {
                            vcfContent += `EMAIL;TYPE=INTERNET:${email}\n`;
                        }
                    }
                    
                    if (companyCol && row[companyCol]) {
                        const company = String(row[companyCol]).trim();
                        if (company) {
                            vcfContent += `ORG:${company}\n`;
                        }
                    }
                    
                    if (titleCol && row[titleCol]) {
                        const title = String(row[titleCol]).trim();
                        if (title) {
                            vcfContent += `TITLE:${title}\n`;
                        }
                    }
                    
                    vcfContent += 'END:VCARD\n\n';
                    count++;
                });
                
                log(`âœ… æˆåŠŸè½¬æ¢ ${count} ä¸ªè”ç³»äºº`, 'success');
                resultArea.classList.add('active');
                
            } catch (error) {
                log('âŒ è½¬æ¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                convertBtn.disabled = false;
            }
        });

        // ä¸‹è½½
        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([vcfContent], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName + '.vcf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('æ–‡ä»¶å·²ä¸‹è½½ï¼Œå¯åœ¨iPhoneä¸Šå¯¼å…¥é€šè®¯å½•', 'success');
        });

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = 'log-line log-' + type;
            line.textContent = message;
            logArea.appendChild(line);
            logArea.scrollTop = logArea.scrollHeight;
        }
    </script>
</body>
</html>

